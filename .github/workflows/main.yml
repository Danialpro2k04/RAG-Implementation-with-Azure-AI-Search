name: Build and Deploy to Azure Container Apps

# This workflow runs on any push to the 'main' branch
on:
  push:
    branches:
      - main

# Environment variables available to all jobs and steps in this workflow
env:
  AZURE_CONTAINER_APP_NAME: demo-container
  AZURE_RESOURCE_GROUP: demo-container
  # IMPORTANT: Change this to your Azure Container Registry name
  AZURE_CONTAINER_REGISTRY: myuniquewineregistry 

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. Check out the repository code
      - name: Checkout repository
        uses: actions/checkout@v3

      # 2. Log in to Azure
      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 3. Log in to the Azure Container Registry
      - name: Log in to ACR
        uses: azure/docker-login@v1
        with:
          login-server: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io
          username: ${{ secrets.ACR_USERNAME }}
          password: ${{ secrets.ACR_PASSWORD }}

      # 4. Build and push the Docker image to ACR
      # The image is tagged with the unique Git commit SHA
      - name: Build and push Docker image
        run: |
          docker build . -t ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/wine-assistant:${{ github.sha }}
          docker push ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/wine-assistant:${{ github.sha }}

      # 5. Deploy the image to Azure Container Apps
      - name: Deploy to Azure Container App
        uses: azure/container-apps-deploy-action@v1
        with:
          # The name of the container app to deploy to
          containerAppName: ${{ env.AZURE_CONTAINER_APP_NAME }}
          # The resource group of the container app
          resourceGroupName: ${{ env.AZURE_RESOURCE_GROUP }}
          # The full path to the image to deploy
          imageToDeploy: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/wine-assistant:${{ github.sha }}
          # Securely set the environment variables for the application
          secrets: |
            AZURE_OPENAI_ENDPOINT=${{ secrets.AZURE_OPENAI_ENDPOINT }}
            AZURE_OPENAI_API_KEY=${{ secrets.AZURE_OPENAI_API_KEY }}
            AZURE_OPENAI_API_VERSION=${{ secrets.AZURE_OPENAI_API_VERSION }}
            EMBEDDING_DEPLOYMENT_NAME=${{ secrets.EMBEDDING_DEPLOYMENT_NAME }}
            CHAT_DEPLOYMENT_NAME=${{ secrets.CHAT_DEPLOYMENT_NAME }}
            SEARCH_SERVICE_NAME=${{ secrets.SEARCH_SERVICE_NAME }}
            SEARCH_API_KEY=${{ secrets.SEARCH_API_KEY }}
            SEARCH_INDEX_NAME=${{ secrets.SEARCH_INDEX_NAME }}
